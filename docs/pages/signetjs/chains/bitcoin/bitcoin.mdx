# Bitcoin Chain Implementation

The Bitcoin chain implementation supports both Bitcoin mainnet and testnet networks, with a focus on P2WPKH (Native SegWit) transactions.

## Configuration

```ts twoslash filename="base.ts"
// [!include ~/snippets/code/contract.ts]
// ---cut---
import { Bitcoin, BTCRpcAdapters } from 'signet.js'

// Initialize the RPC adapter using Mempool
const btcRpcAdapter = new BTCRpcAdapters.Mempool('https://mempool.space/api')

// Initialize the chain
const chain = new Bitcoin({
  network: 'testnet', // 'mainnet' | 'testnet' | 'regtest'
  contract,
  btcRpcAdapter,
})
```

## RPC Adapter

The RPC adapter is a class that provides an interface for interacting with the Bitcoin network. It handles essential operations such as:

- Fetching UTXOs (Unspent Transaction Outputs)
- Retrieving transaction details
- Getting current network fees
- Broadcasting transactions
- Querying address balances

The adapter abstracts away the complexity of different Bitcoin API providers, allowing you to easily switch between services like Mempool.space, BlockCypher, or your own Bitcoin node.

For detailed implementation and configuration options, see the [RPC Adapter](/signetjs/chains/bitcoin/btc-rpc-adapter) documentation.

## Methods

### getBalance

Gets the native token balance of an address in the chain's base units.

```ts twoslash
// [!include base.ts]
// ---cut---
const { balance, decimals } = await chain.getBalance('bc1qx...')
```

**Parameters:**

- `address`: The Bitcoin P2WPKH address to check

**Returns:**

- The balance in the chain's base units as a bigint
- The number of decimals used to format the balance

### deriveAddressAndPublicKey

Derives an Bitcoin address and public key from a predecessor ID and derivation path.

```ts twoslash
// [!include base.ts]
// ---cut---
const { address, publicKey } = await chain.deriveAddressAndPublicKey(
  'bc1qx...',
  'any_string'
)
```

**Parameters:**

- `predecessor`: The wallet/contract address requesting the signature
- `path`: The derivation path to use

**Returns:**

- Object containing:
  - `address`: The derived Bitcoin P2WPKH address
  - `publicKey`: The corresponding public key in SEC1 uncompressed format

### prepareTransactionForSigning

Prepares a transaction for MPC signing.

```ts twoslash filename="unsigned-transaction.ts"
// [!include base.ts]
// ---cut---
import { BTCTransactionRequest } from 'signet.js'

// Simple transfer format
const transactionRequest: BTCTransactionRequest = {
  from: 'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh',
  to: 'bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4',
  value: '0.001', // 0.001 BTC
  publicKey: '0235a3...',
}

const { transaction: unsignedTransaction, mpcPayloads } =
  await chain.prepareTransactionForSigning(transactionRequest)
```

### attachTransactionSignature

Adds signatures to a PSBT.

```ts twoslash filename="add-signature.ts"
// [!include unsigned-transaction.ts]
// ---cut---
import { RSVSignature } from 'signet.js'

// Ideally it would be a request to the Sig Network Smart Contract
const mpcSignatures: RSVSignature[] = [
  {
    r: '0x...',
    s: '0x...',
    v: 27,
  },
]

const signedTx = chain.attachTransactionSignature({
  transaction: unsignedTransaction,
  mpcSignatures,
})
```

**Parameters:**

- `transaction`: The unsigned transaction with PSBT
- `mpcSignatures`: Array of RSV signatures from MPC

**Returns:**

- The serialized signed transaction in hex format

### broadcastTx

Broadcasts a signed transaction to the network.

```ts twoslash
// [!include base.ts]
// ---cut---
const txHash = await chain.broadcastTx('0x...transactionSerialized')
```

**Parameters:**

- `txSerialized`: The serialized signed transaction

**Returns:**

- The transaction hash

## Types

The following types are used on the Bitcoin chain:

```ts twoslash
// [!include ~/../src/chains/Bitcoin/types.ts]
```

## Technical Details

The implementation:

- Uses `bitcoinjs-lib` for transaction handling
- Supports P2WPKH (Native SegWit) addresses
- Handles automatic UTXO selection and change outputs
- Supports custom fee rates through the RPC adapter
- Uses PSBT (Partially Signed Bitcoin Transactions)
- Supports both mainnet and testnet networks../../../../snippets/docs/chain/broadcast-tx
