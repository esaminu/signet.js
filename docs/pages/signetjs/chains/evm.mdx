# EVM Chain Implementation

This implementation supports all EVM-compatible networks (Ethereum, Binance Smart Chain, Polygon, etc.).

## Configuration

```ts twoslash filename="base.ts"
// [!include ~/snippets/code/contract.ts]
// ---cut---
import { EVM } from 'signet.js'

// Initialize the chain
const chain = new EVM({
  rpcUrl: 'https://mainnet.infura.io/v3/YOUR-PROJECT-ID',
  contract,
})
```

## Methods

### getBalance

Gets the native token balance of an address in the chain's base units.

```ts twoslash
// [!include base.ts]
// ---cut---
const { balance, decimals } = await chain.getBalance('0x...')
```

**Parameters:**

- `address`: The EVM address to check

**Returns:**

- The balance in the chain's base units as a bigint
- The number of decimals used to format the balance

### deriveAddressAndPublicKey

Derives an EVM address and public key from a predecessor ID and derivation path.

```ts twoslash
// [!include base.ts]
// ---cut---
const { address, publicKey } = await chain.deriveAddressAndPublicKey(
  '0x...',
  'any_string'
)
```

**Parameters:**

- `predecessor`: The wallet/contract address requesting the signature
- `path`: The derivation path to use

**Returns:**

- Object containing:
  - `address`: The derived EVM address
  - `publicKey`: The corresponding public key in SEC1 uncompressed format

### prepareTransactionForSigning

Prepares a transaction for MPC signing.

```ts twoslash filename="unsigned-transaction.ts"
// [!include base.ts]
// ---cut---
import { EVMTransactionRequest } from 'signet.js'

const transactionRequest: EVMTransactionRequest = {
  to: '0x...',
  from: '0x...',
  value: 100000000000000000n,
  data: '0x...',
}

const { transaction: unsignedTransaction, mpcPayloads } =
  await chain.prepareTransactionForSigning(transactionRequest)
```

The transaction is enhanced with:

- Gas estimation
- Nonce calculation
- Chain ID
- EIP-1559 fee parameters

### attachTransactionSignature

Adds a signature to an unsigned transaction.

```ts twoslash
// [!include unsigned-transaction.ts]
// ---cut---
import { RSVSignature } from 'signet.js'

// Ideally it would be a request to the Sig Network Smart Contract
const mpcSignatures: RSVSignature[] = [
  {
    r: '0x...',
    s: '0x...',
    v: 27,
  },
]

const txSerialized = await chain.attachTransactionSignature({
  transaction: unsignedTransaction,
  mpcSignatures,
})
```

**Parameters:**

- `transaction`: The unsigned transaction
- `mpcSignatures`: Array of RSV signatures from MPC

**Returns:**

- The serialized signed transaction

### broadcastTx

Broadcasts a signed transaction to the network.

```ts twoslash
// [!include base.ts]
// ---cut---
const txHash = await chain.broadcastTx('0x...transactionSerialized')
```

**Parameters:**

- `txSerialized`: The serialized signed transaction

**Returns:**

- The transaction hash

### prepareMessageForSigning

Prepares a message for MPC signing according to EIP-191.

```ts twoslash filename="message-signing.ts"
// [!include base.ts]
// ---cut---
import { EVMMessage } from 'signet.js'

const message: EVMMessage = 'Sign this message'

const { mpcPayloads } = await chain.prepareMessageForSigning(message)
```

**Parameters:**

- `message`: The message to be signed

**Returns:**

- Object containing:

  - `message`: The original message
  - `mpcPayloads`: Array of payloads for MPC signing

### attachMessageSignature

Adds a signature to a message.

```ts twoslash
// [!include message-signing.ts]
// ---cut---
import { RSVSignature } from 'signet.js'

// Ideally it would be a request to the Sig Network Smart Contract
const mpcSignatures: RSVSignature[] = [
  {
    r: '0x...',
    s: '0x...',
    v: 27,
  },
]

const signature = chain.attachMessageSignature({
  message,
  mpcSignatures,
})
```

**Parameters:**

- `message`: The message that was signed
- `mpcSignatures`: Array of RSV signatures from MPC

**Returns:**

- The signature in hex format

### prepareTypedDataForSigning

Prepares EIP-712 typed data for MPC signing.

```ts twoslash filename="typed-data-signing.ts"
// [!include base.ts]
// ---cut---
import { EVMTypedData } from 'signet.js'

const typedData: EVMTypedData = {
  domain: {
    name: 'Test',
    version: '1',
    chainId: 1,
    verifyingContract: '0x1234567890123456789012345678901234567890',
  },
  types: {
    Person: [
      { name: 'name', type: 'string' },
      { name: 'wallet', type: 'address' },
    ],
  },
  primaryType: 'Person',
  message: {
    name: 'Bob',
    wallet: '0x1234567890123456789012345678901234567890',
  },
}

const { typedData: preparedTypedData, mpcPayloads } =
  await chain.prepareTypedDataForSigning(typedData)
```

**Parameters:**

- `typedData`: The EIP-712 typed data object to be signed

**Returns:**

- Object containing:
  - `typedData`: The original typed data
  - `mpcPayloads`: Array of payloads for MPC signing

### attachTypedDataSignature

Adds a signature to typed data.

```ts twoslash
// [!include typed-data-signing.ts]
// ---cut---
import { RSVSignature } from 'signet.js'

// Ideally it would be a request to the Sig Network Smart Contract
const mpcSignatures: RSVSignature[] = [
  {
    r: '0x...',
    s: '0x...',
    v: 27,
  },
]

const signature = chain.attachTypedDataSignature({
  typedData: preparedTypedData,
  mpcSignatures,
})
```

**Parameters:**

- `typedData`: The typed data that was signed
- `mpcSignatures`: Array of RSV signatures from MPC

**Returns:**

- The signature in hex format

## Adding New EVM Chains

To add support for a new EVM-compatible chain, you only need to configure the provider URL. The chain ID and network configuration are automatically retrieved from the provider.

```ts twoslash
// [!include ~/snippets/code/contract.ts]
// ---cut---
import { EVM } from 'signet.js'

// For Polygon (Matic)
const polygonChain = new EVM({
  rpcUrl: 'https://polygon-rpc.com',
  contract,
})

// For Binance Smart Chain
const bscChain = new EVM({
  rpcUrl: 'https://bsc-dataseed.binance.org',
  contract,
})

// For Arbitrum
const arbitrumChain = new EVM({
  rpcUrl: 'https://arb1.arbitrum.io/rpc',
  contract,
})
```

## Types

The following types are used on the EVM chain:

```ts twoslash
// [!include ~/../src/chains/EVM/types.ts]
```

## Technical Details

The implementation:

- Uses `viem` for transaction handling and RPC communication
- Supports both legacy and EIP-1559 transactions
- Handles automatic nonce management
- Supports contract interactions through ABI encoding
- Provides automatic gas estimation and fee calculation
- Compatible with all EVM-based networks
- Supports ENS name resolution on networks that implement it
- Handles transaction signing according to EIP-155
- Supports raw transaction data for custom contract interactions
- Supports EIP-191 personal message signing
- Supports EIP-712 typed data signing
